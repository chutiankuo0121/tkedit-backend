# Dockeré…ç½® - é’ˆå¯¹2æ ¸16Gé«˜æ€§èƒ½ç¯å¢ƒä¼˜åŒ–

# ä½¿ç”¨å®˜æ–¹Python 3.11é•œåƒ
FROM python:3.11-slim

# è®¾ç½®å®¹å™¨å†…çš„å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®Pythonç¯å¢ƒå˜é‡ï¼Œé’ˆå¯¹é«˜æ€§èƒ½ç¯å¢ƒä¼˜åŒ–
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONHASHSEED=random \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DOCKER_CONTAINER=true

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ŒåŒ…æ‹¬åª’ä½“åˆ†ææ‰€éœ€çš„ffmpegå’Œcurl(ç”¨äºå¥åº·æ£€æŸ¥)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# å°†ä¾èµ–æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨ä¸­
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY ./app ./app
COPY ./draft_template ./draft_template
COPY ./run.py .

# ğŸ”§ åˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶è®¾ç½®æ­£ç¡®çš„æƒé™
# ä½¿ç”¨æ›´å®½æ¾çš„æƒé™ä»¥ç¡®ä¿åœ¨ä¸åŒä¸»æœºç³»ç»Ÿä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ
RUN mkdir -p /app/data/logs /app/data/output /tmp && \
    chmod 777 /app/data && \
    chmod 777 /app/data/logs && \
    chmod 777 /app/data/output && \
    chmod 777 /tmp

# ğŸ”§ ä¸ºäº†å…¼å®¹æ€§ï¼Œæš‚æ—¶ä½¿ç”¨rootç”¨æˆ·è¿è¡Œ
# åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥åˆ‡æ¢åˆ°érootç”¨æˆ·
# RUN groupadd -r appuser && useradd -r -g appuser appuser && \
#     chown -R appuser:appuser /app && \
#     chmod -R 755 /app/data
# USER appuser

# è®¾ç½®ç«¯å£ç¯å¢ƒå˜é‡
ENV PORT=7860

# å£°æ˜å®¹å™¨å°†ç›‘å¬çš„ç«¯å£
EXPOSE 7860

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=60s --timeout=15s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:7860/api/v1/system/health || exit 1

# ğŸš€ é’ˆå¯¹2æ ¸16Gé«˜æ€§èƒ½ç¯å¢ƒçš„å¯åŠ¨ä¼˜åŒ–
CMD ["uvicorn", "app.main:app", \
     "--host", "0.0.0.0", \
     "--port", "7860", \
     "--workers", "4", \
     "--access-log", \
     "--log-level", "warning", \
     "--loop", "uvloop"] 