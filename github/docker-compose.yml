# Dockerç¼–æ’é…ç½® - é’ˆå¯¹2æ ¸16Gé«˜æ€§èƒ½ç¯å¢ƒä¼˜åŒ–
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "7860:7860"
    volumes:
      # å°†æœ¬åœ°çš„dataç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®åº“å’Œæ—¥å¿—
      - ./data:/app/data
      # æŒ‚è½½draft_templateç›®å½•ï¼ˆå¦‚æœéœ€è¦ä¿®æ”¹æ¨¡æ¿ï¼‰
      - ./draft_template:/app/draft_template:ro
    env_file:
      # ä» .env æ–‡ä»¶åŠ è½½R2å­˜å‚¨é…ç½®
      - .env
    restart: unless-stopped
    
    # é’ˆå¯¹2æ ¸16Gçš„èµ„æºé…ç½®
    deploy:
      resources:
        limits:
          memory: 15G         # é™åˆ¶æœ€å¤§å†…å­˜ä½¿ç”¨15GBï¼Œé¢„ç•™1GBç»™ç³»ç»Ÿ
          cpus: '1.8'         # é™åˆ¶CPUä½¿ç”¨90%ï¼Œé¢„ç•™10%ç»™ç³»ç»Ÿ
        reservations:
          memory: 1G          # ä¿è¯æœ€å°1GBå†…å­˜
          cpus: '0.2'         # ä¿è¯æœ€å°10%CPU
    
    # ğŸ”§ ç¯å¢ƒå˜é‡ - æœ€å°åŒ–é…ç½®
    environment:
      # ğŸ³ Dockerç¯å¢ƒæ ‡è¯†
      - DOCKER_CONTAINER=true
      
      # ğŸ—„ï¸ æ•°æ®åº“é…ç½® - å®¹å™¨å†…ç»å¯¹è·¯å¾„
      - DATABASE_URL=sqlite+aiosqlite:////app/data/app.db

      # ğŸŒ æœåŠ¡å™¨é…ç½®
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=7860
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860/api/v1/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # æ—¥å¿—é…ç½® - é«˜æ€§èƒ½ç¯å¢ƒå¯ä»¥é€‚å½“æ”¾å®½
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5" 